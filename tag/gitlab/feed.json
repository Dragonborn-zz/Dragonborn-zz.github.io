{
    "version": "https://jsonfeed.org/version/1",
    "title": "Dragonborn-zz's个人博客 • All posts by \"gitlab\" tag",
    "description": "",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2023/04/30/docker%E9%83%A8%E7%BD%B2gitlab%E7%A7%81%E6%9C%8D/",
            "url": "http://example.com/2023/04/30/docker%E9%83%A8%E7%BD%B2gitlab%E7%A7%81%E6%9C%8D/",
            "title": "docker部署gitlab私服",
            "date_published": "2023-04-30T00:13:01.000Z",
            "content_html": "<h4 id=\"前置条件\"><a class=\"markdownIt-Anchor\" href=\"#前置条件\">#</a> 前置条件</h4>\n<p>安装 docker, 配置国内镜像源</p>\n<h4 id=\"部署命令使用了一个汉化的版本\"><a class=\"markdownIt-Anchor\" href=\"#部署命令使用了一个汉化的版本\">#</a> 部署命令（使用了一个汉化的版本）</h4>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">docker run -d -p <span class=\"hljs-number\">443</span>:<span class=\"hljs-number\">443</span> -p <span class=\"hljs-number\">80</span>:<span class=\"hljs-number\">80</span> -p <span class=\"hljs-number\">222</span>:<span class=\"hljs-number\">22</span> --name gitlab --restart always -v <span class=\"hljs-regexp\">/home/gi</span>tlab<span class=\"hljs-regexp\">/config:/</span>etc<span class=\"hljs-regexp\">/gitlab -v /</span>home<span class=\"hljs-regexp\">/gitlab/</span>logs:<span class=\"hljs-regexp\">/var/</span>log<span class=\"hljs-regexp\">/gitlab -v /</span>home<span class=\"hljs-regexp\">/gitlab/</span>data:<span class=\"hljs-regexp\">/var/</span>opt<span class=\"hljs-regexp\">/gitlab docker.io/</span>twang2218/gitlab-ce-zh<br></code></pre></td></tr></table></figure>\n<p>把你服务器的端口映射到容器内部的 443 或者 80</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">-v <span class=\"hljs-regexp\">/home/gi</span>tlab<span class=\"hljs-regexp\">/config:/</span>etc/gitlab  <br></code></pre></td></tr></table></figure>\n<p>这里把容器的配置文件夹映射到服务器真实目录 /home/gitlab/config</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">-v <span class=\"hljs-regexp\">/home/gi</span>tlab<span class=\"hljs-regexp\">/logs:/</span>var<span class=\"hljs-regexp\">/log/gi</span>tlab<br></code></pre></td></tr></table></figure>\n<p>这里把容器的日志文件夹映射到服务器真实目录 /home/gitlab/logs</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">-v <span class=\"hljs-regexp\">/home/gi</span>tlab<span class=\"hljs-regexp\">/data:/</span>var<span class=\"hljs-regexp\">/opt/gi</span>tlab<br></code></pre></td></tr></table></figure>\n<p>这里把容器的存储文件夹映射到服务器真实目录 /home/gitlab/data</p>\n<h4 id=\"进入容器配置gitlab\"><a class=\"markdownIt-Anchor\" href=\"#进入容器配置gitlab\">#</a> 进入容器配置 gitlab</h4>\n<ul>\n<li>1. 进入容器</li>\n</ul>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">docker exec -it gitlab <span class=\"hljs-regexp\">/bin/</span>bash<br></code></pre></td></tr></table></figure>\n<ul>\n<li>2. 修改配置文件</li>\n</ul>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">vim <span class=\"hljs-regexp\">/etc/gi</span>tlab/gitlab.rb<br></code></pre></td></tr></table></figure>\n<ul>\n<li>3. 配置</li>\n</ul>\n<figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs livescript\"><span class=\"hljs-comment\">#外部访问地址</span><br> external_url <span class=\"hljs-string\">&#x27;http://124.225.116.118:35236&#x27;</span><br><span class=\"hljs-comment\">#gitlab时区</span><br> gitlab_rails[<span class=\"hljs-string\">&#x27;time_zone&#x27;</span>] = <span class=\"hljs-string\">&#x27;UTC&#x27;</span><br><br><span class=\"hljs-comment\">#gitlab邮件通知</span><br> gitlab_rails[<span class=\"hljs-string\">&#x27;gitlab_email_enabled&#x27;</span>] = <span class=\"hljs-literal\">true</span><br> gitlab_rails[<span class=\"hljs-string\">&#x27;gitlab_email_from&#x27;</span>] = <span class=\"hljs-string\">&#x27;2513178346@qq.com&#x27;</span><br> gitlab_rails[<span class=\"hljs-string\">&#x27;smtp_enable&#x27;</span>] = <span class=\"hljs-literal\">true</span><br> gitlab_rails[<span class=\"hljs-string\">&#x27;smtp_address&#x27;</span>] = <span class=\"hljs-string\">&quot;smtp.qq.com&quot;</span><br> gitlab_rails[<span class=\"hljs-string\">&#x27;smtp_port&#x27;</span>] = <span class=\"hljs-number\">465</span><br> gitlab_rails[<span class=\"hljs-string\">&#x27;smtp_user_name&#x27;</span>] = <span class=\"hljs-string\">&quot;2513178346@qq.com&quot;</span><br> gitlab_rails[<span class=\"hljs-string\">&#x27;smtp_password&#x27;</span>] = <span class=\"hljs-string\">&quot;你的&quot;</span><br> gitlab_rails[<span class=\"hljs-string\">&#x27;smtp_domain&#x27;</span>] = <span class=\"hljs-string\">&quot;qq.com&quot;</span><br> gitlab_rails[<span class=\"hljs-string\">&#x27;smtp_authentication&#x27;</span>] = <span class=\"hljs-string\">&quot;login&quot;</span><br> gitlab_rails[<span class=\"hljs-string\">&#x27;smtp_enable_starttls_auto&#x27;</span>] = <span class=\"hljs-literal\">true</span><br> gitlab_rails[<span class=\"hljs-string\">&#x27;smtp_tls&#x27;</span>] = <span class=\"hljs-literal\">true</span><br> gitlab_rails[<span class=\"hljs-string\">&#x27;smtp_pool&#x27;</span>] = <span class=\"hljs-literal\">true</span><br><span class=\"hljs-comment\">#可选，配置ip限流、白名单</span><br> gitlab_rails[<span class=\"hljs-string\">&#x27;rack_attack_git_basic_auth&#x27;</span>] = &#123;<br>   <span class=\"hljs-string\">&#x27;enabled&#x27;</span> =&gt; <span class=\"hljs-literal\">true</span>,<br>   <span class=\"hljs-string\">&#x27;ip_whitelist&#x27;</span> =&gt; [<span class=\"hljs-string\">&quot;127.0.0.1&quot;</span>],<br>   <span class=\"hljs-string\">&#x27;maxretry&#x27;</span> =&gt; <span class=\"hljs-number\">100</span>,<br>   <span class=\"hljs-string\">&#x27;findtime&#x27;</span> =&gt; <span class=\"hljs-number\">60</span>,<br>   <span class=\"hljs-string\">&#x27;bantime&#x27;</span> =&gt; <span class=\"hljs-number\">3600</span><br> &#125;<br></code></pre></td></tr></table></figure>\n<h4 id=\"重启服务\"><a class=\"markdownIt-Anchor\" href=\"#重启服务\">#</a> 重启服务</h4>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs crmsh\">gitlab-ctl <span class=\"hljs-literal\">stop</span><br>gitlab-ctl reconfigure<br>gitlab-ctl <span class=\"hljs-literal\">start</span><br></code></pre></td></tr></table></figure>\n<h4 id=\"一些常见问题\"><a class=\"markdownIt-Anchor\" href=\"#一些常见问题\">#</a> 一些常见问题</h4>\n<p>1. 同一个 ip 短时间并发可能会触发限流</p>\n<p>解决办法</p>\n<p>方法一、暂时解决，进入容器执行命令删除 IP 黑名单</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">redis-cli -s <span class=\"hljs-regexp\">/var/</span>opt<span class=\"hljs-regexp\">/gitlab/</span>redis/redis.socket<br>keys *attack*<br>del <span class=\"hljs-string\">&quot;上一步查到的键值&quot;</span><br></code></pre></td></tr></table></figure>\n<p>方法二、加 IP 白名单（如果有固定 ip 可以这么做）或增加并发阈值</p>\n<figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs livescript\"><span class=\"hljs-comment\">#可选，配置ip限流、白名单</span><br> gitlab_rails[<span class=\"hljs-string\">&#x27;rack_attack_git_basic_auth&#x27;</span>] = &#123;<br>   <span class=\"hljs-string\">&#x27;enabled&#x27;</span> =&gt; <span class=\"hljs-literal\">true</span>,<br>   <span class=\"hljs-comment\">#ip白名单</span><br>   <span class=\"hljs-string\">&#x27;ip_whitelist&#x27;</span> =&gt; [<span class=\"hljs-string\">&quot;127.0.0.1&quot;</span>],<br>   <span class=\"hljs-comment\">#并发阈值</span><br>   <span class=\"hljs-string\">&#x27;maxretry&#x27;</span> =&gt; <span class=\"hljs-number\">100</span>,<br>   <span class=\"hljs-string\">&#x27;findtime&#x27;</span> =&gt; <span class=\"hljs-number\">60</span>,<br>   <span class=\"hljs-string\">&#x27;bantime&#x27;</span> =&gt; <span class=\"hljs-number\">3600</span><br> &#125;<br></code></pre></td></tr></table></figure>\n",
            "tags": [
                "docker",
                "gitlab"
            ]
        }
    ]
}